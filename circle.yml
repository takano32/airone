
## test machine
machine:
  timezone: Asia/Tokyo
  python:
    version: 3.5.0

## dependencies
dependencies:
  override:
    - pip install tox tox-pyenv coverage
    - cd /opt/circleci/.pyenv && git pull
    - |
      if [[ ! -d ~/.pyenv/versions/3.6.1 ]]; then
        pyenv install 3.6.1
      fi
    - pyenv local 2.7.10 3.4.3 3.5.0 3.6.1
  cache_directories:
    - ~/.pyenv/versions/3.6.1

## test definition
test:
  override:
    - tox
  post:
    - coverage report > coverage.txt
    - echo "build $CIRCLE_BUILD_URL" > coverage-summary.txt
    - echo "git   $CIRCLE_COMPARE_URL" >> coverage-summary.txt
    - head -n 1 coverage.txt >> coverage-summary.txt && tail -n 1 coverage.txt >> coverage-summary.txt
    - |
      echo '{"text":"' > coverage.json && cat coverage.txt >> coverage.json && echo '"}' >> coverage.json
    - |
      curl -s -S -H 'Content-type: application/json' -X POST --data "$(cat coverage.json)" $SLACK_ENDPOINT
    
