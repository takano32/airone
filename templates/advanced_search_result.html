{% extends 'base.html' %}

{% block title %}Advanced Search (Result){% endblock %}

{% block nav_sub_header %}
<div class="conatiner-fluid">
  <ul class="breadcrumb airone-breadcrumb">
    <li class="breadcrumb-item"><a href="/">TOP</a></li>
    <li class="breadcrumb-item"><a href='/dashboard/advanced_search'>高度な検索</a></li>
    <li class="breadcrumb-item">検索結果</li>
  </ul>
</div>
{% endblock %}

{% block content %}
{% load bitwise_tags %}
<div class="container">
  <div class="row">
    <div class="col-9">
      <h4>
      検索結果
      <span id='entry_count'>
        ({{ results.ret_count }}{% if results.ret_count >= max_num %}{% endif %} 件)
      </span>
      </h4>
    </div>
    <div class="col-3">
      <form id='form_export' action='/dashboard/advanced_search_export' method='post'>
        {% csrf_token %}
        <input type='hidden' name='entities' value='[{{ entities }}]' />
        <input type='hidden' name='attrinfo' value='[]' />
        <input type='hidden' name='export_style' value='' />
        {% if has_referral %}
          <input type='hidden' id='param_export_csv_referral' name='has_referral' value='' />
        {% endif %}

        <div class="container">
          <div class="row">
            <div class="col">
              <button type="button" class="btn btn-primary btn-sm export_yaml">YAML 出力</button>
            </div>
            <div class="col">
              <button type="button" class="btn btn-primary btn-sm export_csv">CSV 出力</button>
            </div>
          </div>
        </div>

      </form>
    </div>
  </div>
</div>

<table class='table table-striped table-bordered table-hover'>
  <thead>
    <tr>
      <th>
        Name<br/>
        <input type='text' class='input-sm narrow_down_entries hint_entry_name' attrname='{{ attrname }}'></input>
      </th>
      {% for attrname in attrs %}
      <th>
        {{ attrname }}<br/>
        <input type='text' class='input-sm narrow_down_entries hint_attr_value' attrname='{{ attrname }}'></input>
      </th>
      {% endfor %}

      {% if has_referral %}
      <th>
        参照エントリ<br/>
        <input type='text' class='input-sm narrow_down_referral'></input>
      </th>
      {% endif %}
    </tr>
  </thead>
  <tbody>
    {% for result in results.ret_values %}
    <tr>
      <th><a href='/entry/show/{{ result.entry.id }}'>{{ result.entry.name }} [{{ result.entity.name }}]</a></th>

      {% for attrname in attrs %}
        {% with result.attrs|get_item:attrname as attr %}
          {% if attr.type == attr_type.string %}
            <td>{{ attr.value }}</td>

          {% elif attr.type == attr_type.textarea %}
            <td>{{ attr.value }}</td>

          {% elif attr.type == attr_type.boolean %}
            <td>{{ attr.value }}</td>

            {% elif attr.type == attr_type.date %}
              <td>{{ attr.value|date:"Y-m-d" }}</td>

          {% elif attr.type == attr_type.entry %}
            <td><a href='/entry/show/{{ attr.value.id }}'>{{ attr.value.name }}</a></td>

          {% elif attr.type == attr_type.named_entry %}
            <td>
              {% for key, value in attr.value.items %}
              <div class='row'>
                <div class='col'>
                  <p class='url_conv'>{{ key }}</p>
                </div>
                <div class='col'>
                  <a href='/entry/show/{{ value.id }}'>{{ value.name }}</a>
                </div>
              </div>
              {% endfor %}
            </td>

          {% elif attr.type == attr_type.group %}
            <td><a href='/group/'>{{ attr.value.name }}</a></td>

          {% elif attr.type == attr_type.array_string %}
            <td>
              <ul class='list-group'>
              {% for value in attr.value %}
                <li class='list-group-item'>{{ value }}</li>
              {% endfor %}
              </ul>
            </td>

          {% elif attr.type == attr_type.array_entry %}
            <td>
              <ul class='list-group'>
              {% for value in attr.value %}
                <li class='list-group-item'><a href='/entry/show/{{ value.id }}'>{{ value.name }}</a></li>
              {% endfor %}
              </ul>
            </td>

          {% elif attr.type == attr_type.array_named_entry %}
            <td>
              <ul class='list-group'>
              {% for item in attr.value %}
                {% for key, value in item.items %}
                <li class='list-group-item'>
                  <div class='row'>
                    <div class='col'>
                      <p class='url_conv'>{{ key }}</p>
                    </div>
                    <div class='col'>
                      <a href='/entry/show/{{ value.id }}'>{{ value.name }}</a>
                    </div>
                  </div>
                </li>
                {% endfor %}
              {% endfor %}
              </ul>
            </td>

          {% else %}
            <td></td>

          {% endif %}
        {% endwith %}
      {% endfor %}

      {% if has_referral %}
      <td>
        <ul class='list-group'>
          {% for referral in result.referrals %}
          <li class='list-group-item'>
            <a href='/entry/show/{{ referral.id }}'>{{ referral.name }} / {{ referral.schema }}</a>
          </li>
          {% endfor %}
        </ul>
      </td>
      {% endif %}
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

{% block script %}
<script>
function make_attr_elem(attr) {
  var new_elem = $('<td />');

  function get_named_column(value) {
    var key = Object.keys(value)[0];
    var ref_value = value[key];

    var value_str = '';
    if (ref_value) {
      value_str = `<a href='/entry/show/${ value.id }'>${ ref_value.name }</a>`;
    }

    return `<div class='row'> \
              <div class='col'> \
                <p class='url_conv'>${ key }</p> \
              </div> \
              <div class='col'>${ value_str }</div> \
            </div>`;
  }

  if (attr && attr.value) {
    switch (attr.type) {
      case {{ attr_type.string }}:
      case {{ attr_type.textarea }}:
      case {{ attr_type.boolean }}:
      case {{ attr_type.date }}:
        new_elem.text(attr.value);
        break;

      case {{ attr_type.entry }}:
        if (attr.value) {
          new_elem.append($(`<a href='/entry/show/${ attr.value.id }'>${ attr.value.name }</a>`));
        }
        break;

      case {{ attr_type.group }}:
        if (attr.value) {
          new_elem.append($(`<a href='/group/'>${ attr.value.name }</a>`));
        }
        break;

      case {{ attr_type.named_entry }}:
        new_elem.append($(get_named_column(attr.value)));
        break;

      case {{ attr_type.array_string }}:
        var elem_ul = $("<ul class='list-group'/>");
        for(var value of attr.value) {
          elem_ul.append($(`<li class='list-group-item'>${ value }</li>`));
        }
        new_elem.append(elem_ul);
        break;

      case {{ attr_type.array_entry }}:
        var elem_ul = $("<ul class='list-group'/>");
        for(var value of attr.value) {
          if(value) {
            elem_ul.append($(`<li class='list-group-item'><a href='/entry/show/${ value.id }'>${ value.name }</a></li>`));
          } else {
            elem_ul.append($(`<li class='list-group-item' />`));
          }
        }
        new_elem.append(elem_ul);
        break;

      case {{ attr_type.array_named_entry }}:
        var elem_ul = $("<ul class='list-group'/>");
        for(var value of attr.value) {
          elem_ul.append($(`<li class='list-group-item'>${ get_named_column(value) }</li>`));
        }
        new_elem.append(elem_ul);
    }
  }

  return new_elem;
}

function reconstruct_tbody(results) {
  var elem_parent = $('tbody');

  // First of all, clear tbody
  elem_parent.children().remove();

  for(var result of results) {
    var new_elem_entry = $('<tr/>');

    new_elem_entry.append(`<th><a href='/entry/show/${ result.entry.id }/'>${ result.entry.name } [${ result.entity.name}]</a></th>`);

    {% for attrname in attrs %}
      new_elem_entry.append(make_attr_elem(result.attrs['{{ attrname }}']));
    {% endfor %}

    {% if has_referral %}
      let elem_ref_td = $('<td/>');
      let elem_ref_ul = $("<ul class='list-group'/>");

      for(let ref of result.referrals) {
        elem_ref_ul.append($(`<li class='list-group-item'><a href='/entry/show/${ ref.id }'>${ ref.name } / ${ ref.schema }</a></li>`));
      }

      elem_ref_td.append(elem_ref_ul)
      new_elem_entry.append(elem_ref_td);
    {% endif %}

    elem_parent.append(new_elem_entry);
  }
}

$(document).ready(function() {
  var sending_request = false;
  var entities = '{{ entities }}';

  function get_attrinfo() {
    ret_value = $('.hint_attr_value').map(function() {
      return {
        'name': $(this).attr('attrname'),
        'keyword': $(this).val(),
      }
    }).get();

    return ret_value;
  }

  function narrow_results_down(e) {
    if(! (e.keyCode != 13 || sending_request)) {
      sending_request = true;

      $('#entry_count').text('(...処理中...)');

      request_params = {
          entities: '{{ entities }}'.split(','),
          entry_name: $('.hint_entry_name').val(),
          attrinfo: get_attrinfo(),
      };

      {% if has_referral %}
      request_params['referral'] = $('.narrow_down_referral').val();
      {% endif %}

      if($('#check_search_all').is(':checked')) {
        request_params['entry_limit'] = 99999;
      }

      $.ajax({
        type: 'POST',
        url: "/api/v1/entry/search",
        data: JSON.stringify(request_params),
        dataType:      'json',
        contentType:   'application/json;charset=utf-8',
        scriptCharset: 'utf-8',
        headers: {
          'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val(),
        },
      }).done(function(data){
        sending_request = false;

        $('#entry_count').text(`(${ data.result.ret_count } 件)`);

        reconstruct_tbody(data.result.ret_values);
      }).fail(function(data){
        MessageBox.error(data.responseText);
      });
    }
  }

  function submit_export(style) {
    MessageBox.clear();

    $.ajax({
      type: 'post',
      url: '/dashboard/advanced_search_export',
      data: JSON.stringify({
        'entities': '{{ entities }}'.split(','),
        'attrinfo': get_attrinfo(),
        'has_referral': $('.narrow_down_referral').val(),
        'export_style': style,
      }),
      dataType:      'json',
      contentType:   'application/json;charset=utf-8',
      scriptCharset: 'utf-8',
      headers: {
        'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val(),
      },
    }).done(function(data) {
      MessageBox.success(data.result);

    }).fail(function(data) {
      MessageBox.error(data.responseText);
    });
  }

  $(".narrow_down_referral").on('keyup', narrow_results_down);
  $(".narrow_down_entries").on('keyup', narrow_results_down);

  $('.export_yaml').on('click', function(e) { submit_export('yaml'); });
  $('.export_csv').on('click', function(e) { submit_export('csv'); });
});
</script>
{% endblock %}
