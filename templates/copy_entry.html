{% extends 'base.html' %}

{% block title %}{{ entry.name }} - Copy Entry{% endblock %}

{% block nav_sub_header %}
{% include 'navigation.html' with object=entry %}
{% endblock %}

{% block content %}
<div class="container-fluid">
  {% include 'entry_tab.html' with tab='copy' %}

  <div class="tab-content">
  <form id="copy-form" name="copy-form" url='{{ form_url }}' method='post'>
  <div class="row">
    <div class="col">
      <div class="float-left">
        <p>入力した各行毎に <a href='/entry/show/{{ entry.id }}'>{{ entry.name }}</a> と同じ属性値を持つ別エントリを作成</p>
      </div>
      <div class="float-right">
        <input type="button" class="btn btn-primary" id="submit-button" value="コピー" />
      </div>
    </div>
  </div>
  <div class='row'>
    <div class="col-5">
      <textarea id="creating_entries" cols="40" rows="10"></textarea>
    </div>
    <div class="col-7">
      <p class='text-muted'>例：'vm0001', 'vm0002', ... 'vm0006' の 6 エントリを作成する場合</p>
      <textarea class="input-disabled" cols="40" rows="8" disabled="True">
vm0001
vm0002
vm0003
vm0004
vm0005
vm0006
      </textarea>
    </div>
  </div>
  {% csrf_token %}
  </form>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
AirOneButtonUtil.initialize(
  $("#submit-button"), gettext("button_copy"), gettext("button_communicating"),
  true, true, function(e) {
  $('#copy-form').submit();
});

$('#copy-form').submit(function(event){
  const SHOW_ALL_COPY_RESULT = 5;

  event.preventDefault();

  // clear old warning
  MessageBox.clear();

  let context = {
    'entries': $(this).find("#creating_entries").val(),
  };
  HttpPost($(this), context).done(function(data) {
    if(data.results.length <= SHOW_ALL_COPY_RESULT) {
      for(let r of data.results) {
        let code = (r.status == 'success') ? MessageBox.SUCCESS : MessageBox.ERROR;
        MessageBox.setNextOnLoadMessage(code, r.msg);
      }
    } else {
      let succeeded = 0;
      for(let r of data.results) {
        if(r.status == 'success') {
          succeeded += 1;
        } else {
          // show all errors even if too many copy
          MessageBox.setNextOnLoadMessage(MessageBox.ERROR, r.msg);
        }
      }
      MessageBox.setNextOnLoadMessage(MessageBox.SUCCESS,
          "Succeeded: copied " + String(succeeded) + " entries(this may take a few minutes).");
    }
    location.href = '{{ redirect_url }}';
  }).fail(function(data) {
    MessageBox.error(data.responseText);
    $('#submit-button').trigger("enableButton");
  });

});

</script>
{% endblock %}
