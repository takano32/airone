{% extends 'base.html' %}

{% block title %}Create new Entity{% endblock %}

{% block nav_sub_header %}
<div class="conatiner-fluid">
  <ul class="breadcrumb airone-breadcrumb">
    <li class="breadcrumb-item"><a href="/">TOP</a></li>
    <li class="breadcrumb-item"><a href='/entity/'>エンティティ一覧</a></li>
    <li class="breadcrumb-item">新規エンティティ作成</li>
  </ul>
</div>
{% endblock %}

{% block content %}
<form url="/entity/do_create" method="post">
  <div class="container-fluid">
    <div class="row">
      <div class="col">
        <div class="float-left">
          <div>
            エンティティ名：<input type='string' name='name'/>
          </div>
          <div>
            備考：<input type='string' name='note' size='50'/>
          </div>
        </div>
        <div class="float-right">
          <input name="button_save" type="submit" class="btn btn-primary" value='保存'></input>
        </div>
      </div>
    </div>
  </div>
  <hr/>
  <div class="container-fluid">

    <div class="row">
      <div class="col">属性名</div>
      <div class="col-4">型</div>
      <div class="col-2">必須</div>
    </div>

    <div name='attributes'>
      <div class="row attr">
        <div class='col'><input type='text' class='attr_name'></input></div>
        <div class='col-4'>
          <select class='attr_type'>
            {% for type in attr_types %}
            <option value='{{ type.type }}'>{{ type.name }}</option>
            {% endfor %}
          </select>
          <select class='attr_referral' style='display:none'>
            {% for entity in entities %}
            <option value='{{ entity.id }}'>{{ entity.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class='col-2'>
          {% if attr.is_mandatory %}
          <input type='checkbox' class='is_mandatory' checked='checked'></input>
          {% else %}
          <input type='checkbox' class='is_mandatory'></input>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- a template of attribute -->
    <div class="row" name='attr_template' style='display:none'>
      <div class='col'><input type='text' class='attr_name'></input></div>
      <div class='col-4'>
        <select class='attr_type'>
          {% for type in attr_types %}
          <option value='{{ type.type }}'>{{ type.name }}</option>
          {% endfor %}
        </select>
        <select class='attr_referral' style='display:none'>
          {% for entity in entities %}
          <option value='{{ entity.id }}'>{{ entity.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class='col-2'>
        <input type='checkbox' class='is_mandatory'></input>
      </div>
    </div>

    <div class="row">
      <div class='col'>
        <button name='add_attr'>属性追加</button>
      </div>
    </div>
  </div>
  {% csrf_token %}
</form>
<script src="/static/js/jquery-3.2.1.min.js"></script>
<script src="/static/js/http_request.js"></script>
<script>
var toggle_referral = function() {
  if($(this).val() == '1') {
    $(this).parent().find('.attr_referral').show();
  } else {
    $(this).parent().find('.attr_referral').hide();
  }
}
$('button[name=add_attr]').on('click', function() {
  append_attr_column();

  return false;
});
$('form').submit(function(){
  var attrs = $('.attr').map(function(index, elem){
    return {
      'name': $(this).find('.attr_name').val(),
      'type': $(this).find('.attr_type').val(),
      'is_mandatory': $(this).find('.is_mandatory:checked').val() != undefined ? true : false,
      'ref_id': $(this).find('.attr_referral').val(),
    };
  });

  HttpPost($(this), {'attrs': attrs.get()});

  return false;
});
$('.attr_type').change(toggle_referral);

var table_column = $('div[name=attr_template]').html();
var append_attr_column = function() {
  var new_column = $('<div class="row attr" />');

  new_column.append($.parseHTML(table_column));
  new_column.find('.attr_type').on('change', toggle_referral);

  $('div[name=attributes]').append(new_column);
}
</script>
{% endblock %}
