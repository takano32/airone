{% extends 'base.html' %}

{% block title %}Edit Entry{% endblock %}

{% block nav_sub_header %}
<div class="conatiner-fluid">
  <ul class="breadcrumb airone-breadcrumb">
    <li class="breadcrumb-item"><a href="/">TOP</a></li>
    <li class="breadcrumb-item"><a href='/entry/{{ entry.schema.id }}'>{{ entry.schema.name }}</a></li>
    <li class="breadcrumb-item"><a href='/entry/show/{{ entry.id }}'>{{ entry.name }}</a></li>
    <li class="breadcrumb-item">{{ entry.name }} の編集</li>
  </ul>
</div>
{% endblock %}

{% block content %}
{% load bitwise_tags %}
<div class="container-fluid">
  <form url='/entry/do_edit/{{ entry.id }}' method='post'>
    <div class='row'>
      <div class="col">
        <div class="float-right">
          <input type="submit" class="btn btn-primary" value='保存'/>
        </div>
        <table class="table table-bordered">
          <tr>
            <td>エントリ名</td>
            <td><input type="text" name="entry_name" value="{{ entry.name }}"/>{% if entry.deleted %}(deleted){% endif %}</td>
          </tr>
        </table>
      </div>
    </div>

    <table class="table table-bordered">
      <thead>
        <th>属性</th>
        <th>属性値</th>
        <th></th>
      </thead>
      <tbody>
        {% include 'edit_entry_attrs.html' %}
      </tbody>
    </table>
    <strong>(*)</strong> は必須項目

    <hr/>
    <h2>RackSpace</h2>
    <table class='table table-sm'>
      <thead>
        <th>#</th>
        <th>target</th>
      </thead>
      <tbody>
      {% for key, targets in rackspace.items %}
      <tr>
        <th>{{ key }}</th>


        <td>
          <button type="button" class="btn btn-primary btn-sm" unit_no='{{ key }}' name='add_rackentry'>add entry</button>
        <div class='array_element'>
          {% for target in targets %}

    <div class="row">
      <div class="col-10">
        <input type="text" class="narrow_down_rse" value="{{ target.referral.name }}" style="width: 100%"/>
        <select class='rse' unit_no='{{ key }}' size='5' style="width: 100%">
          <option value='{{ target.referral.id }}' selected='true'>{{ target.referral.name }}</option>
        </select>
      </div>
      <div class="col-2">
        <button type="button" class="btn btn-danger btn-sm" name="del_attr">del</button>
      </div>
    </div>

          {% endfor %}
        </div>
        </td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
    {% csrf_token %}
  </form>
</div>
{% endblock %}

{% block script %}
<script>
$('form').submit(function(){
  var attrs = [];
  {% for attr in attributes %}
  attrs.push({
    'id': '{{ attr.id }}',
    'value': $(this).find(".attr_value[attr_id='{{ attr.id }}']").map(function(i, e) {
      if(! ($(e).val() == '0' || $(e).val() == '')) {
        return $(e).val();
      }
    }).get(),
  });
  {% endfor %}

  var rse_entries = [];
  $('.rse').each(function() {
    if ($(this).val()) {
      rse_entries.push({
        'position': $(this).attr('unit_no'),
        'target_id': $(this).val(),
      });
    }
  });
  console.log(rse_entries);

  HttpPost($(this), {'attrs': attrs, 'rse_info': rse_entries});

  return false;
});

var append_column = function(container, template, value_setter) {
  var new_column = $('<div class="row" />');

  new_column.append($.parseHTML(template.html()));

  // set value to the new column
  value_setter(new_column);

  container.append(new_column);
};

var del_column = function() {
  // remove selected column
  $(this).parent().parent().remove();

  return false;
}

var update_option = function(select_elem) {
  var input_str = $(select_elem).val();
  $(select_elem).parent().parent().find('select option').each(function(i, elem) {
    if($(elem).val() != 0) {
      if(($(elem).text().toLowerCase().indexOf(input_str) >= 0) ||
         ($(elem).text().toUpperCase().indexOf(input_str) >= 0)) {
        $(elem).show();
      } else {
        $(elem).hide();
      }
    }
  });
}

var enable_key_handling = true;
var narrow_down_handler = {
  "compositionstart": function() {
    enable_key_handling = false;
  },
  "compositionend": function() {
    enable_key_handling = true;

    update_option(this);
  },
  "keyup": function(e) {
    var inp = String.fromCharCode(e.keyCode);
    var is_BS = (e.keyCode == 8);

    if (!(!enable_key_handling || !(/[a-zA-Z0-9-_ ]/.test(inp) || is_BS))) {
      update_option(this);
    }
  }
}

var update_selected_item = function() {
  var attr_id = $(this).attr('attr_id');
  var text = $(this).find('option:selected').text();

  $(this).parent().find('li[attr_id="'+ attr_id +'"]').text(text);
}

$('button[name=add_attr]').on('click', function() {
  var container = $(this).parent().find('.array_element');
  var new_column = $('<div class="row" />');

  new_column.append($.parseHTML($(this).parent().find('.attr_value_template').html()));
  new_column.find('button[name=del_attr]').on('click', del_column);
  new_column.find('.narrow_down_referral').on(narrow_down_handler);
  new_column.find(".attr_value").on('change', update_selected_item);

  container.prepend(new_column);

  return false;
});

// Initiate array values
{% for attr in attributes %}
  {% if attr.type|bitwise_and:attr_type_value.array %}
    var container = $('#container-{{ attr.id }}');
    var template = $('#template-{{ attr.id }}');
    var value_setter = undefined;

    {% for value in attr.last_value %}
      {% if attr.type == attr_type.array_string %}
        value_setter = function(new_column) {
          new_column.find('.attr_value').val('{{ value }}');
        };
        append_column(container, template, value_setter);
      {% elif attr.type == attr_type.array_entry %}
        value_setter = function(new_column) {
          var elem_option = new_column.find('option[value="{{ value.id }}"]');
          elem_option.attr('selected', 'True');

          // show selected item name
          new_column.find('li[attr_id="{{ attr.id }}"]').text('{{ value.name }}');
        }
        append_column(container, template, value_setter);
      {% endif %}
    {% endfor %}
  {% endif %}
{% endfor %}

$(document).ready(function() {
  $('button[name=del_attr]').on('click', del_column);
  $(".narrow_down_referral").on(narrow_down_handler);
  $(".attr_value").on('change', update_selected_item);
});

// processing for rackspace entries
var RSE_REFERRALS = [
{% for entry in rse_referrals %}
  {"id": "{{ entry.id }}", "name": "{{ entry.name }}"},
{% endfor %}
];


var update_rse_option = function(text_elem) {
  var input_str = $(text_elem).val();
  var select_elem = $(text_elem).parent().find('select');

  select_elem.empty();
  for(var data of RSE_REFERRALS) {
    if(data['name'].toLowerCase().indexOf(input_str) >= 0 || data['name'].toUpperCase().indexOf(input_str) >= 0) {
      select_elem.append($(`<option value='${data["id"]}'>${data['name']}</option>`));
    }
  }
}
var narrow_down_rack_entry = {
  "compositionstart": function() {
    enable_key_handling = false;
  },
  "compositionend": function() {
    enable_key_handling = true;

    update_rse_option(this);
  },
  "keyup": function(e) {
    var inp = String.fromCharCode(e.keyCode);
    var is_BS = (e.keyCode == 8);

    if (!(!enable_key_handling || !(/[a-zA-Z0-9-_ ]/.test(inp) || is_BS))) {
      update_rse_option(this);
    }
  }
}
$('button[name=add_rackentry]').on('click', function() {
  var container = $(this).parent().find('.array_element');
  var new_column = $('\
    <div class="row"> \
      <div class="col-10"> \
        <input type="text" class="narrow_down_rse" placeholder="絞り込み"  style="width: 100%"/> \
        <select class="rse" size="5" style="width: 100%"> \
        </select> \
      </div> \
\
      <div class="col-2"> \
        <button type="button" class="btn btn-danger btn-sm" name="del_attr">del</button> \
      </div> \
    </div> \
  ');
  new_column.find('.narrow_down_rse').on(narrow_down_rack_entry);
  new_column.find('button[name=del_attr]').on('click', del_column);
  new_column.find('select').attr('unit_no', $(this).attr('unit_no'));

  container.prepend(new_column);
});

$(document).ready(function() {
  $(".narrow_down_rse").on(narrow_down_rack_entry);
});
</script>
{% endblock %}
