{% extends 'base.html' %}

{% block title %}Create ACLs{% endblock %}

{% block nav_sub_header %}
<div class="conatiner-fluid">
  <ul class="breadcrumb airone-breadcrumb">
    <li class="breadcrumb-item"><a href="/dashboard/">top</a></li>
    <li class="breadcrumb-item"><a href="/entity/">エンティティ一覧</a></li>
    <li class="breadcrumb-item">ACL作成</li>
  </ul>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col">
      <h2>ACL作成</h2>
    </div>
  </div>
  <div class="row">
    <div class="col">
      <div class="float-left form-group">
      </div>
      <div class="float-right">
        <button id="submit" name="submit" type="button" class="btn btn-primary">保存</button>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col">
      <form id="form" name="form" url="/acl/set" action="/acl/set" method="post">
        {% csrf_token %}
        <input type="hidden" name="object_id" value="{{ object.id }}" />
        <input type="hidden" name="object_type" value="{{ object.objtype }}" />
        公開：<input type="checkbox" name="is_public" {% if object.is_public %}checked="checked"{% endif %}/>
        <table class="table table-bordered">
          <thead>
            <tr>
              <td>ユーザ or グループ</td>
              <td>権限</td>
            </tr>
          </thead>
          <tbody>
            {% for member in members %}
            <tr>
              <td>{{ member.name }}</td>
              <td>
                <select name='acl' member_id='{{ member.id }}' member_type='{{ member.type }}'>
                  {% for acltype in acltypes %}
                    {% if acltype.id == member.current_permission %}
                      <option value='{{ acltype.id }}' selected='selected'>{{ acltype.name }}</option>
                    {% else %}
                      <option value='{{ acltype.id }}'>{{ acltype.name }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </form>
    </div>
  </div>
</div>

<script src="/static/js/jquery-3.2.1.min.js"></script>
<script>
  $("#submit").click(function() {
    var acl = [];
  
    $("#form").find('select[name=acl]').each(function(){
      acl.push({
        'member_type': $(this).attr('member_type'),
        'member_id': $(this).attr('member_id'),
        'value': $(this).val() != "" ? $(this).val() : null,
      });
    });
    HttpPost($("#form"), {'acl': acl});
    return false;
  });  
</script>

{% endblock %}
