{% extends 'base.html' %}

{% block title %}Edit Entity{% endblock %}

{% block nav_sub_header %}
<div class="conatiner-fluid">
  <ul class="breadcrumb airone-breadcrumb">
    <li class="breadcrumb-item"><a href="/">TOP</a></li>
    <li class="breadcrumb-item"><a href='/entity/'>エンティティ一覧</a></li>
    <li class="breadcrumb-item">{{ entity.name }}</li>
  </ul>
</div>
{% endblock %}

{% block content %}
<form url="/entity/do_edit/{{ entity.id }}" method="post">
  <div class="container-fluid">
    <div class="row">
      <div class="col">
        <div class="float-left">
          <div>
            エンティティ名：<input type='string' name='name' value='{{ entity.name }}'/>
          </div>
          <div>
            備考：<input type='string' name='note' value='{{ entity.note }}' size='50'/>
          </div>
        </div>
        <div class="float-right">
          <input name="button_save" type="submit" class="btn btn-primary" value='保存'></input>
        </div>
      </div>
    </div>
  </div>
  <hr/>
  <div class="container-fluid">

    <div class="row">
      <div class="col">属性名</div>
      <div class="col-2">型</div>
      <div class="col-2">必須</div>
    </div>

    <div name='attributes'>
      {% for attr in attributes %}
      <div class="row attr" attr_id='{{ attr.id }}'>
        <div class='col'><input type='text' class='attr_name' value='{{ attr.name }}'></input></div>
        <div class='col-2'>
          <select class='attr_type'>
            {% for type in attr_types %}
            <option value='{{ type.type }}'>{{ type.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class='col-2'>
          {% if attr.is_mandatory %}
          <input type='checkbox' class='is_mandatory' checked='checked'></input>
          {% else %}
          <input type='checkbox' class='is_mandatory'></input>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- a template of attribute -->
    <div class="row" name='attr_template' style='display:none'>
      <div class='col'><input type='text' class='attr_name'></input></div>
      <div class='col-2'>
        <select class='attr_type'>
          {% for type in attr_types %}
          <option value='{{ type.type }}'>{{ type.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class='col-2'>
        <input type='checkbox' class='is_mandatory'></input>
      </div>
    </div>

    <div class="row">
      <div class='col'>
        <button name='add_attr'>属性追加</button>
      </div>
    </div>
  </div>
  {% csrf_token %}
</form>
<script src="/static/js/jquery-3.2.1.min.js"></script>
<script src="/static/js/http_request.js"></script>
<script>
$('button[name=add_attr]').on('click', function() {
  append_attr_column();

  return false;
});
$('form').submit(function(){
  var attrs = []
  $('.attr').each(function(index){
    attrs.push({
      'id': $(this).attr('attr_id'),
      'name': $(this).find('.attr_name').val(),
      'type': $(this).find('.attr_type').val(),
      'is_mandatory': $(this).find('.is_mandatory:checked').val() != undefined ? true : false,
    });
  });

  console.info(attrs)

  HttpPost($(this), {'attrs': attrs});

  return false;
});

var table_column = $('div[name=attr_template]').html();
var append_attr_column = function() {
  var new_column = $('<div class="row attr" />');

  new_column.append($.parseHTML(table_column));

  $('div[name=attributes]').append(new_column);
}
</script>
{% endblock %}
