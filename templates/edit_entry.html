{% extends 'base.html' %}

{% block title %}Edit Entry{% endblock %}

{% block nav_sub_header %}
<div class="conatiner-fluid">
  <ul class="breadcrumb airone-breadcrumb">
    {% for header in nav_headers %}
      {% if header.href %}
      <li class="breadcrumb-item"><a href="{{ header.href }}">{{ header.text }}</a></li>
      {% else %}
      <li class="breadcrumb-item">{{ header.text }}</li>
      {% endif %}
    {% endfor %}
  </ul>
</div>
{% endblock %}

{% block content %}
{% load bitwise_tags %}
<div class="container-fluid">
  <form url='{{ form_url }}' method='post'>
    <div class='row'>
      <div class="col">
        <div class="float-right">
          <input type="submit" class="btn btn-primary" value='保存'/>
        </div>
        <table class="table table-bordered">
          <tr>
            <td>エントリ名</td>
            <td><input type="text" name="entry_name" value="{{ entry.name }}"/>{% if entry.deleted %}(deleted){% endif %}</td>
          </tr>
        </table>
      </div>
    </div>

    <table class="table table-bordered">
      <thead>
        <th>属性</th>
        <th>属性値</th>
        <th></th>
      </thead>
      <tbody>
        {% include 'edit_entry_attrs.html' %}
      </tbody>
    </table>

    <strong>(*)</strong> は必須項目
    {% csrf_token %}
  </form>
</div>
{% endblock %}

{% block script %}
<script>
$('form').submit(function(){
  var attrs = []

  {% for attr in attributes %}
  attrs.push({
    'id': '{{ attr.id }}',
    'value': $(this).find(".attr_value[attr_id='{{ attr.id }}']").map(function(i, e) {
      if(! ($(e).val() == '0' || $(e).val() == '')) {
        if($(e).attr('type') == 'checkbox') {
          return $(e).prop('checked');
        } else {
          return $(e).val();
        }
      }
    }).get(),
  });
  {% endfor %}

  HttpPost($(this), {'attrs': attrs});

  return false;
});

var append_column = function(container, template, value_setter) {
  var new_column = $('<div class="row" />');

  new_column.append($.parseHTML(template.html()));

  // set value to the new column
  value_setter(new_column);

  container.append(new_column);
};

var del_column = function() {
  // remove selected column
  $(this).parent().parent().remove();

  return false;
}

var filter_options = function(input_elem) {
  var input_str = $(input_elem).val();
  $(input_elem).parent().parent().find('select option').each(function(i, elem) {
    if($(elem).val() != 0) {
      if(($(elem).text().toLowerCase().indexOf(input_str) >= 0) ||
         ($(elem).text().toUpperCase().indexOf(input_str) >= 0)) {
        $(elem).show();
      } else {
        $(elem).hide();
      }
    }
  });
}
var replace_options = function(input_elem, referrals) {
  var select_elem = $(input_elem).parent().parent().find('select');

  select_elem.empty();

  select_elem.append($('<option />').val(0).text('- NO SET -'));
  for(var ref of referrals) {
    select_elem.append($('<option />').val(ref.id).text(ref.name));
  }
}

var sending_request = false;
var update_option = function(input_elem) {
  if($(input_elem).attr('use_api')) {
    if(! sending_request) {
      sending_request = true;
      $.ajax({
        type: 'GET',
        url: `/entry/api/v1/get_attr_referrals/${ $(input_elem).attr('attr_id') }/`,
        data: {
          keyword: $(input_elem).val(),
        },
      }).done(function(data){
        replace_options(input_elem, data['results']);

        // reset sending flag
        sending_request = false
      }).fail(function(data){
        MessageBox.error('failed to load data from server (Please reload this page or call Administrator)');
      });
    }
  } else {
    filter_options(input_elem);
  }
}

var enable_key_handling = true;
var narrow_down_handler = {
  "compositionstart": function() {
    enable_key_handling = false;
  },
  "compositionend": function() {
    enable_key_handling = true;

    update_option(this);
  },
  "keyup": function(e) {
    var inp = String.fromCharCode(e.keyCode);
    var is_BS = (e.keyCode == 8);

    if (!(!enable_key_handling || !(/[a-zA-Z0-9-_ ]/.test(inp) || is_BS))) {
      update_option(this);
    }
  }
}

var update_selected_item = function() {
  var attr_id = $(this).attr('attr_id');
  var text = $(this).find('option:selected').text();

  $(this).parent().find('li[attr_id="'+ attr_id +'"]').text(text);
}

$('button[name=add_attr]').on('click', function() {
  var container = $(this).parent().find('.array_element');
  var new_column = $('<div class="row" />');

  new_column.append($.parseHTML($(this).parent().find('.attr_value_template').html()));
  new_column.find('button[name=del_attr]').on('click', del_column);
  new_column.find('.narrow_down_referral').on(narrow_down_handler);
  new_column.find(".attr_value").on('change', update_selected_item);

  container.prepend(new_column);

  return false;
});

// Initiate array values
{% for attr in attributes %}
  {% if attr.type|bitwise_and:attr_type_value.array %}
    var container = $('#container-{{ attr.id }}');
    var template = $('#template-{{ attr.id }}');
    var value_setter = undefined;

    {% for value in attr.last_value %}
      {% if attr.type == attr_type.array_string %}
        value_setter = function(new_column) {
          new_column.find('.attr_value').val('{{ value }}');
        };
        append_column(container, template, value_setter);
      {% elif attr.type == attr_type.array_entry %}
        value_setter = function(new_column) {
          var elem_option = new_column.find('option[value="{{ value.id }}"]');
          elem_option.attr('selected', 'True');

          // show selected item name
          new_column.find('li[attr_id="{{ attr.id }}"]').text('{{ value.name }}');
        }
        append_column(container, template, value_setter);
      {% endif %}
    {% endfor %}
  {% endif %}
{% endfor %}

$(document).ready(function() {
  $('button[name=del_attr]').on('click', del_column);
  $(".narrow_down_referral").on(narrow_down_handler);
  $(".attr_value").on('change', update_selected_item);
});
</script>
{% endblock %}
