<script>
function do_update_attr(e) {
  let modal_content = $(e.target).parents('.modal-content');

  MessageBox.clear();

  $.ajax({ type: 'POST',
    url: "/entry/api/v1/update_attr_with_attrv",
    data: JSON.stringify({
      'attr_id': modal_content.find('.modal_attr_id').val(),
      'attrv_id': modal_content.find('.modal_attrv_id').val(),
    }),
    headers: {
      'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()
    }
  }).done(function(data) {
    MessageBox.setNextOnLoadMessage(MessageBox.SUCCESS, data);

    location.href = '/entry/show/{{ entry.id }}';

  }).fail(function(data) {
    MessageBox.error(data.responseText);
  });
}

function prep_renew_modal(e) {
  //let elem_parent = $(e.target).parent().parent().parent().parent();
  let elem_parent = $(e.target).parents('.attr_info');

  $('#renew_checkbox .modal_attr_name').text(elem_parent.find('.attr_name').text());
  $('#renew_checkbox .modal_attr_value').html($(elem_parent.find('.attr_value').html()));
  $('#renew_checkbox .modal_updated_time').text(elem_parent.find('.updated_time').text());
  $('#renew_checkbox .modal_attr_id').val(elem_parent.find('.attr_id').val());
  $('#renew_checkbox .modal_attrv_id').val(elem_parent.find('.attrv_id').val());
}

var history_count = {{ history_count }};
var history_index = {{ history_count }};
var attr_type = {
  'entry': {{ attr_type.entry }},
  'string': {{ attr_type.string }},
  'textarea': {{ attr_type.textarea }},
  'named_entry': {{ attr_type.named_entry }},
  'boolean': {{ attr_type.boolean }},
  'group': {{ attr_type.group }},
  'date': {{ attr_type.date }},
  'array_entry': {{ attr_type.array_entry }},
  'array_string': {{ attr_type.array_string }},
  'array_named_entry': {{ attr_type.array_named_entry }},
};
function show_old_history(e) {
  MessageBox.clear();

  $.ajax({ type: 'GET',
    url: "/entry/api/v1/get_entry_history/{{ entry.id }}/",
    data: {
      'count': history_count,
      'index': history_index,
    },
    headers: {
      'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()
    }
  }).done(function(data) {
    let container = $('.airone-entry-table-history');
    
    // update history index value
    get_count = data['results'].length;
    if (get_count > 0) {
      history_index += get_count;

      for(let value of data['results']) {
        append_history_item(container, value)
      }
    } else {
      $(e.target).hide();
    }

    // enable to push button
    $(e.target).trigger('enableButton');

  }).fail(function(data) {
    MessageBox.error(data.responseText);
  });
}

function make_element_value_text(info) {
  if (info.attr_type == attr_type.entry) {
    return `<a href='/entry/show/${ info.attr_value.id }'>${ info.attr_value.name }</a>`;

  } else if (info.attr_type == attr_type.string || info.attr_type == attr_type.textarea) {
    return `<span class='url_conv'>${ info.attr_value }</span>`;

  } else if (info.attr_type == attr_type.boolean) {
    if(info.attr_value) {
      return "<input type='checkbox' disabled='True' checked='True'/>";
    } else {
      return "<input type='checkbox' disabled='True'/>";
    }

  } else if (info.attr_type == attr_type.named_entry) {
    let ref_value = '';
    if(info.attr_value.referral != null) {
      ref_value = `<a href='/entry/show/${ info.attr_value.referral.id }'>${ info.attr_value.referral.name }</a>`;
    }

    return `<div class ='row'>` +
             `<div class ='col-3'>${ info.attr_value.value }</div>` +
             `<div class ='col-9'>${ ref_value }</div>` +
           `</div>`;

  } else if (info.attr_type == attr_type.group) {
    return `<a href='/group/edit/${ info.attr_value.id }'>{{ info.attr_value.name }}</a>`;

  } else if (info.attr_type == attr_type.date) {
    return `<span>${ info.attr_value }</span>`;

  } else if (info.attr_type == attr_type.array_entry) {
    let result = "<ul class='list-group'>";
    for (let co_info of info.attr_value) {
      result += `<li class='list-group-item'>` +
                  `<a href='/entry/show/${ co_info.id }'>${ co_info.name }</a>` +
                `</li>`;
    }
    result += '</ul>';
    return result;

  } else if (info.attr_type == attr_type.array_string) {
    let result = "<ul class='list-group'>";
    for (let co_info of info.attr_value) {
      result += `<li class='list-group-item'>${ co_info }</li>`;
    }
    result += '</ul>';
    return result;

  } else if (info.attr_type == attr_type.array_named_entry) {
    let result = "<ul class='list-group'>";
    for (let co_info of info.attr_value) {
      let ref_value = '';
      if(co_info.referral != null) {
        ref_value = `<a href='/entry/show/${ co_info.referral.id }'>${ co_info.referral.name }</a>`;
      }
      result += `<li class='list-group-item'>` +
                  `<div class='row'>` +
                    `<div class='col-3'>${ co_info.value  }</div>` +
                    `<div class='col-9'>${ ref_value }</div>` +
                  `</div>` +
                `</li>`;
    }
    result += '</ul>';
    return result;
  }
}

function append_history_item(container, info) {
  let elem_tr = $(`<tr class='attr_info'>`);

  // set attribute and attribute value id
  elem_tr.append(`<input type='hidden' class='attrv_id' value='${ info.attrv_id }' />`);
  elem_tr.append(`<input type='hidden' class='attr_id' value='${ info.attr_id }' />`);

  // set attribute name
  elem_tr.append(`<td class='attr_name'>${ info.attr_name }</td>`);

  // set attribute value
  let value_text = '';
  if(info.attr_value !== null && info.attr_value !== '') {
    value_text = make_element_value_text(info);
  }
  elem_tr.append(`<td class='attr_value'>${ value_text }</td>`);

  // set upated user
  elem_tr.append(`<td class='updated_user'>${ info.created_user }</td>`);

  // set upated time
  elem_tr.append(`<td class='updated_time'>${ info.created_time }</td>`);

  // set update button
  let elem_td = $('<td>');
  let elem_button = $(`<span class='replace_attrv' data-toggle="tooltip">` +
                      `<a href='#'>` +
                      `<img src='/static/images/update.png' data-toggle="modal" data-target="#renew_checkbox"/>` +
                      `</a></span>`);

  elem_button.prop('title', gettext('button_history_desc_replace')).tooltip();
  elem_button.on('click', prep_renew_modal);

  elem_td.append(elem_button);
  elem_tr.append(elem_td);

  container.append(elem_tr);
}

$(document).ready(function() {
  // initialize text information for each elements
  $('#renew_checkbox_title').text(gettext('modal_history_title'));
  $('#renew_checkbox .desc').text(gettext('modal_history_desc'));
  $('.replace_attrv').prop('title', gettext('button_history_desc_replace')).tooltip();

  // initialize event handlers
  $('.replace_attrv').on('click', prep_renew_modal);

  AirOneButtonUtil.initialize($('.show_old_history'), gettext('button_history_more'),
                              gettext('button_communicating'), true, true, show_old_history);

  AirOneButtonUtil.initialize($('.modal-footer .do_update_attr'), gettext('button_update'),
                              gettext('button_communicating'), true, true, do_update_attr);
});
</script>
